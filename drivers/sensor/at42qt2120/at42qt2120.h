/*
 * Copyright (c) 2023 Kelly Helmut Lord
 *
 * SPDX-License-Identifier: Apache-2.0
 */

#ifndef ZEPHYR_DRIVERS_SENSOR_AT42QT2120_H_
#define ZEPHYR_DRIVERS_SENSOR_AT42QT2120_H_

#include <zephyr/drivers/sensor.h>
#include <zephyr/drivers/i2c.h>
#include <zephyr/drivers/gpio.h>

/* AT42QT2120 Register Addresses */
#define AT42QT2120_REG_CHIP_ID 0x00
#define AT42QT2120_REG_FIRMWARE_VERSION 0x01
#define AT42QT2120_REG_DETECTION_STATUS 0x02
#define AT42QT2120_REG_KEY_STATUS_BASE 0x03
#define AT42QT2120_REG_SLIDER_POSITION 0x05
#define AT42QT2120_REG_CALIBRATE 0x06
#define AT42QT2120_REG_RESET 0x07
#define AT42QT2120_REG_LOW_POWER 0x08
#define AT42QT2120_REG_ACQUISITION_TIME AT42QT2120_REG_LOW_POWER
#define AT42QT2120_REG_TOWARD_TOUCH_DRIFT_COMPENSATION 0x09
#define AT42QT2120_REG_AWAY_TOUCH_DRIFT_COMPENSATION 0x0a
#define AT42QT2120_REG_DETECTION_INTEGRATOR 0x0b
#define AT42QT2120_REG_TOUCH_RECALIBRATION_DELAY 0x0c
#define AT42QT2120_REG_DRIFT_HOLD_TIME 0x0d
#define AT42QT2120_REG_SLIDER_OPTIONS 0x0e
#define AT42QT2120_REG_CHARGE_TIME 0x0f
#define AT42QT2120_REG_KEY0_DETECT_THRESHOLD 0x10
#define AT42QT2120_REG_KEY1_DETECT_THRESHOLD 0x11
#define AT42QT2120_REG_KEY2_DETECT_THRESHOLD 0x12
#define AT42QT2120_REG_KEY3_DETECT_THRESHOLD 0x13
#define AT42QT2120_REG_KEY4_DETECT_THRESHOLD 0x14
#define AT42QT2120_REG_KEY5_DETECT_THRESHOLD 0x15
#define AT42QT2120_REG_KEY6_DETECT_THRESHOLD 0x16
#define AT42QT2120_REG_KEY7_DETECT_THRESHOLD 0x17
#define AT42QT2120_REG_KEY8_DETECT_THRESHOLD 0x18
#define AT42QT2120_REG_KEY9_DETECT_THRESHOLD 0x19
#define AT42QT2120_REG_KEY10_DETECT_THRESHOLD 0x1a
#define AT42QT2120_REG_KEY11_DETECT_THRESHOLD 0x1b
#define AT42QT2120_REG_KEY_CONTROL_BASE 0x1c
#define AT42QT2120_REG_KEY0_CONTROL 0x1c
#define AT42QT2120_REG_KEY1_CONTROL 0x1d
#define AT42QT2120_REG_KEY2_CONTROL 0x1e
#define AT42QT2120_REG_KEY3_CONTROL 0x1f
#define AT42QT2120_REG_KEY4_CONTROL 0x20
#define AT42QT2120_REG_KEY5_CONTROL 0x21
#define AT42QT2120_REG_KEY6_CONTROL 0x22
#define AT42QT2120_REG_KEY7_CONTROL 0x23
#define AT42QT2120_REG_KEY8_CONTROL 0x24
#define AT42QT2120_REG_KEY9_CONTROL 0x25
#define AT42QT2120_REG_KEY10_CONTROL 0x26
#define AT42QT2120_REG_KEY11_CONTROL 0x27
#define AT42QT2120_REG_KEY0_PULSE_SCALE 0x28
#define AT42QT2120_REG_KEY1_PULSE_SCALE 0x29
#define AT42QT2120_REG_KEY2_PULSE_SCALE 0x2a
#define AT42QT2120_REG_KEY3_PULSE_SCALE 0x2b
#define AT42QT2120_REG_KEY4_PULSE_SCALE 0x2c
#define AT42QT2120_REG_KEY5_PULSE_SCALE 0x2d
#define AT42QT2120_REG_KEY6_PULSE_SCALE 0x2e
#define AT42QT2120_REG_KEY7_PULSE_SCALE 0x2f
#define AT42QT2120_REG_KEY8_PULSE_SCALE 0x30
#define AT42QT2120_REG_KEY9_PULSE_SCALE 0x31
#define AT42QT2120_REG_KEY10_PULSE_SCALE 0x32
#define AT42QT2120_REG_KEY11_PULSE_SCALE 0x33
#define AT42QT2120_REG_KEY_SIGNAL_0 0x34
#define AT42QT2120_REG_KEY_SIGNAL_1 0x36
#define AT42QT2120_REG_KEY_SIGNAL_2 0x38
#define AT42QT2120_REG_KEY_SIGNAL_3 0x3a
#define AT42QT2120_REG_KEY_SIGNAL_4 0x3c
#define AT42QT2120_REG_KEY_SIGNAL_5 0x3e
#define AT42QT2120_REG_KEY_SIGNAL_6 0x40
#define AT42QT2120_REG_KEY_SIGNAL_7 0x42
#define AT42QT2120_REG_KEY_SIGNAL_8 0x44
#define AT42QT2120_REG_KEY_SIGNAL_9 0x46
#define AT42QT2120_REG_KEY_SIGNAL_10 0x48
#define AT42QT2120_REG_KEY_SIGNAL_11 0x4a
#define AT42QT2120_REG_REFERENCE_DATA_0 0x4c
#define AT42QT2120_REG_REFERENCE_DATA_1 0x4e
#define AT42QT2120_REG_REFERENCE_DATA_2 0x50
#define AT42QT2120_REG_REFERENCE_DATA_3 0x52
#define AT42QT2120_REG_REFERENCE_DATA_4 0x54
#define AT42QT2120_REG_REFERENCE_DATA_5 0x56
#define AT42QT2120_REG_REFERENCE_DATA_6 0x58
#define AT42QT2120_REG_REFERENCE_DATA_7 0x5a
#define AT42QT2120_REG_REFERENCE_DATA_8 0x5c
#define AT42QT2120_REG_REFERENCE_DATA_9 0x5e
#define AT42QT2120_REG_REFERENCE_DATA_10 0x60
#define AT42QT2120_REG_REFERENCE_DATA_11 0x62

/* AT42QT2120 Values */
#define AT42QT2120_CHIP_ID 0x3E
#define AT42QT2120_RESET_VALUE 0x1
#define AT42QT2120_CALIBRATE_VALUE 0x1
#define AT42QT2120_LOW_POWER_VALUE 0x0
#define AT42QT2120_KEY_CONTROL_ENABLE 0x0
#define AT42QT2120_KEY_CONTROL_DISABLE BIT(0)


/* AT42QT2120 Register Value Masks */

#define AT42QT2120_SDET_MSK BIT(1)
#define AT42QT2120_SDET_SET(x) (((x) & 0x1) << 1)
#define AT42QT2120_SDET_GET(x) (((x) >> 1) & 0x1)

#define AT42QT2120_TDET_MSK BIT(0)
#define AT42QT2120_TDET_SET(x) (((x) & 0x1) << 0)
#define AT42QT2120_TDET_GET(x) (((x) >> 0) & 0x1)

#define AT42QT2120_OVERFLOW_MSK BIT(6)
#define AT42QT2120_OVERFLOW_SET(x) (((x) & 0x1) << 6)
#define AT42QT2120_OVERFLOW_GET(x) (((x) >> 6) & 0x1)

#define AT42QT2120_CALIBRATE_MSK BIT(7)
#define AT42QT2120_CALIBRATE_SET(x) (((x) & 0x1) << 7)
#define AT42QT2120_CALIBRATE_GET(x) (((x) >> 7) & 0x1)

#define AT42QT2120_KEY_STATUS_0_MSK BIT(0)
#define AT42QT2120_KEY_STATUS_0_SET(x) (((x) & 0x1) << 0)
#define AT42QT2120_KEY_STATUS_0_GET(x) (((x) >> 0) & 0x1)

#define AT42QT2120_KEY_STATUS_1_MSK BIT(1)
#define AT42QT2120_KEY_STATUS_1_SET(x) (((x) & 0x1) << 1)
#define AT42QT2120_KEY_STATUS_1_GET(x) (((x) >> 1) & 0x1)

#define AT42QT2120_KEY_STATUS_2_MSK BIT(2)
#define AT42QT2120_KEY_STATUS_2_SET(x) (((x) & 0x1) << 2)
#define AT42QT2120_KEY_STATUS_2_GET(x) (((x) >> 2) & 0x1)

#define AT42QT2120_KEY_STATUS_3_MSK BIT(3)
#define AT42QT2120_KEY_STATUS_3_SET(x) (((x) & 0x1) << 3)
#define AT42QT2120_KEY_STATUS_3_GET(x) (((x) >> 3) & 0x1)

#define AT42QT2120_KEY_STATUS_4_MSK BIT(4)
#define AT42QT2120_KEY_STATUS_4_SET(x) (((x) & 0x1) << 4)
#define AT42QT2120_KEY_STATUS_4_GET(x) (((x) >> 4) & 0x1)

#define AT42QT2120_KEY_STATUS_5_MSK BIT(5)
#define AT42QT2120_KEY_STATUS_5_SET(x) (((x) & 0x1) << 5)
#define AT42QT2120_KEY_STATUS_5_GET(x) (((x) >> 5) & 0x1)

#define AT42QT2120_KEY_STATUS_6_MSK BIT(6)
#define AT42QT2120_KEY_STATUS_6_SET(x) (((x) & 0x1) << 6)
#define AT42QT2120_KEY_STATUS_6_GET(x) (((x) >> 6) & 0x1)

#define AT42QT2120_KEY_STATUS_7_MSK BIT(7)
#define AT42QT2120_KEY_STATUS_7_SET(x) (((x) & 0x1) << 7)
#define AT42QT2120_KEY_STATUS_7_GET(x) (((x) >> 7) & 0x1)

#define AT42QT2120_KEY_STATUS_8_MSK BIT(0)
#define AT42QT2120_KEY_STATUS_8_SET(x) (((x) & 0x1) << 0)
#define AT42QT2120_KEY_STATUS_8_GET(x) (((x) >> 0) & 0x1)

#define AT42QT2120_KEY_STATUS_9_MSK BIT(1)
#define AT42QT2120_KEY_STATUS_9_SET(x) (((x) & 0x1) << 1)
#define AT42QT2120_KEY_STATUS_9_GET(x) (((x) >> 1) & 0x1)

#define AT42QT2120_KEY_STATUS_10_MSK BIT(2)
#define AT42QT2120_KEY_STATUS_10_SET(x) (((x) & 0x1) << 2)
#define AT42QT2120_KEY_STATUS_10_GET(x) (((x) >> 10) & 0x1)

#define AT42QT2120_KEY_STATUS_11_MSK BIT(3)
#define AT42QT2120_KEY_STATUS_11_SET(x) (((x) & 0x1) << 3)
#define AT42QT2120_KEY_STATUS_11_GET(x) (((x) >> 3) & 0x1)

#define AT42QT2120_SLIDER_ENABLE_MSK BIT(7)
#define AT42QT2120_SLIDER_ENABLE_SET(x) (((x) & 0x1) << 7)
#define AT42QT2120_SLIDER_ENABLE_GET(x) (((x) >> 7) & 0x1)

#define AT42QT2120_WHEEL_ENABLE_MSK BIT(6)
#define AT42QT2120_WHEEL_ENABLE_SET(x) (((x) & 0x1) << 6)
#define AT42QT2120_WHEEL_ENABLE_GET(x) (((x) >> 6) & 0x1)

#define AT42QT2120_KEY_GUARD_MSK BIT(4)
#define AT42QT2120_KEY_GUARD_SET(x) (((x) & 0x1) << 4)
#define AT42QT2120_KEY_GUARD_GET(x) (((x) >> 4) & 0x1)

#define AT42QT2120_AKS_GROUP_MSK (BIT(3) | BIT(2))
#define AT42QT2120_AKS_GROUP_SET(x) (((x) & 0x3) << 2)
#define AT42QT2120_AKS_GROUP_GET(x) (((x) >> 2) & 0x3)

#define AT42QT2120_GPO_MSK BIT(1)
#define AT42QT2120_GPO_SET(x) (((x) & 0x1) << 1)
#define AT42QT2120_GPO_GET(x) (((x) >> 1) & 0x1)

#define AT42QT2120_ENABLE_MSK BIT(0)
#define AT42QT2120_ENABLE_SET(x) (((x) & 0x1) << 0)
#define AT42QT2120_ENABLE_GET(x) (((x) >> 0) & 0x1)

#define AT42QT2120_PULSE_MSK GENMASK(7, 4)
#define AT42QT2120_PULSE_SET(x) (((x) & 0xF) << 4)
#define AT42QT2120_PULSE_GET(x) (((x) >> 4) & 0xF)

#define AT42QT2120_SCALE_MSK GENMASK(3, 0)
#define AT42QT2120_SCALE_SET(x) (((x) & 0xF) << 0)
#define AT42QT2120_SCALE_GET(x) (((x) >> 0) & 0xF)

struct at42qt2120_data {
	uint8_t rotation;

	const struct device *dev;
	struct gpio_callback gpio_cb;
	struct k_work work;
};

struct at42qt2120_config {
	struct i2c_dt_spec i2c;
	struct gpio_dt_spec reset_gpio;
	struct gpio_dt_spec change_gpio;
	uint8_t acquisition_time;
	uint8_t toward_touch_drift;
	uint8_t away_touch_drift;
	uint8_t detection_integrator;
	uint8_t touch_recal_delay;
	uint8_t drift_hold_time;
	uint8_t charge_time;
};

#endif  /* ZEPHYR_DRIVERS_SENSOR_AT42QT2120_H_ */
